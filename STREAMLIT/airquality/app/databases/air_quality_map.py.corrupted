
import folium
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from datetime import datetime, timedelta
import numpy as np
from db_utils import AirQualityDB
import webbrowser
import os

class AirQualityMapper:
    """Classe pour crÃ©er des cartes de qualitÃ© de l'air"""
    
    def __init__(self, address: str = None):
        """
        Initialise le mapper
        
        Args:
            address: Adresse pour laquelle charger les donnÃ©es
        """
        self.address = address
        self.db = AirQualityDB(address=address) if address else AirQualityDB()
        
    def create_pollution_color(self, pm25_value):
        """DÃ©terminer la couleur basÃ©e sur la valeur PM2.5"""
        if pd.isna(pm25_value):
            return 'gray'
        elif pm25_value <= 10:
            return 'green'
        elif pm25_value <= 20:
            return 'yellow'
        elif pm25_value <= 25:
            return 'orange'
        else:
            return 'red'
    
    def get_air_quality_index(self, pm25):
        """Convertir PM2.5 en indice de qualitÃ© de l'air"""
        if pd.isna(pm25):
            return "DonnÃ©es non disponibles", "gray"
        elif pm25 <= 10:
            return "Bon", "green"
        elif pm25 <= 20:
            return "ModÃ©rÃ©", "lightgreen"  # Remplace 'yellow' qui n'est pas valide pour folium.Icon
        elif pm25 <= 25:
            return "Mauvais pour groupes sensibles", "orange"
        else:
            return "Mauvais", "red"
    
    def create_location_map(self, address):
        """CrÃ©er une carte pour une adresse spÃ©cifique"""
        # RÃ©cupÃ©rer les donnÃ©es pour cette adresse
        location_data = self.db.get_location_data(address)
        
        if location_data.empty:
            print(f"âŒ Aucune donnÃ©e trouvÃ©e pour l'adresse : {address}")
            return None
            
        # Obtenir le rÃ©sumÃ© de la localisation
        summary = self.db.get_location_summary(address)
        if not summary:
            print(f"âŒ Impossible de gÃ©nÃ©rer le rÃ©sumÃ© pour : {address}")
            return None
            
        # CoordonnÃ©es centrales
        center_lat = summary['latitude']
        center_lon = summary['longitude']
        
        # CrÃ©er la carte
        m = folium.Map(
            location=[center_lat, center_lon],
            zoom_start=12,
            tiles='OpenStreetMap'
        )
        
        # DerniÃ¨re mesure disponible
        latest_data = location_data.iloc[0]
        latest_pm25 = latest_data['pm2_5']
        aqi_label, aqi_color = self.get_air_quality_index(latest_pm25)
        
        # Popup avec informations dÃ©taillÃ©es
        popup_html = f"""
        <div style="width: 300px;">
            <h4>ğŸ“ {summary['address']}</h4>
            <hr>
            <p><strong>ğŸ• DerniÃ¨re mesure :</strong> {latest_data['date']}</p>
            <p><strong>ğŸŒ¡ï¸ QualitÃ© de l'air :</strong> <span style="color: {aqi_color}; font-weight: bold;">{aqi_label}</span></p>
            <hr>
            <p><strong>ğŸ“Š Moyennes sur la pÃ©riode :</strong></p>
            <ul>
                <li>PM2.5: {summary['avg_pm2_5']:.1f} Î¼g/mÂ³</li>
                <li>PM10: {summary['avg_pm10']:.1f} Î¼g/mÂ³</li>
                <li>NOâ‚‚: {summary['avg_no2']:.1f} Î¼g/mÂ³</li>
                <li>Oâ‚ƒ: {summary['avg_o3']:.1f} Î¼g/mÂ³</li>
                <li>SOâ‚‚: {summary['avg_so2']:.1f} Î¼g/mÂ³</li>
            </ul>
            <hr>
            <p><strong>âš ï¸ Alertes pollution :</strong> {summary['pollution_alert_pct']:.1f}% du temps</p>
            <p><strong>ğŸ“… PÃ©riode :</strong> {summary['start_date']} Ã  {summary['end_date']}</p>
            <p><strong>ğŸ“Š Enregistrements :</strong> {summary['total_records']}</p>
        </div>
        """
        
        # Ajouter le marqueur principal
        folium.Marker(
            [center_lat, center_lon],
            popup=folium.Popup(popup_html, max_width=400),
            tooltip=f"{summary['address']} - {aqi_label}",
            icon=folium.Icon(
                color=aqi_color,
                icon='info-sign',
                prefix='glyphicon'
            )
        ).add_to(m)
        
        # Ajouter un cercle pour reprÃ©senter la zone d'influence
        folium.Circle(
            location=[center_lat, center_lon],
            radius=150,  # 1km de rayon
            popup=f"Zone d'influence (100m) - {summary['address']}",
            color=aqi_color,
            fillColor=aqi_color,
            fillOpacity=0.2
        ).add_to(m)
        
        return m, summary
    
    def create_data_visualization(self, address):
        """CrÃ©er des graphiques pour une adresse"""
        try:
            location_data = self.db.get_location_data(address)
            
            if location_data.empty:
                print(f"âš ï¸ Aucune donnÃ©e disponible pour {address}")
                return None
            
            # VÃ©rifier les colonnes nÃ©cessaires
            required_cols = ['date', 'pm2_5', 'pm10', 'nitrogen_dioxide', 'ozone', 'sulphur_dioxide']
            missing_cols = [col for col in required_cols if col not in location_data.columns]
            if missing_cols:
                print(f"âš ï¸ Colonnes manquantes : {missing_cols}")
                return None
                
            # Convertir la date en datetime
            location_data['date'] = pd.to_datetime(location_data['date'])
            location_data = location_data.sort_values('date')
            
            # CrÃ©er la figure avec plusieurs sous-graphiques
            fig, axes = plt.subplots(2, 2, figsize=(16, 12))
            fig.suptitle(f'Analyse de la qualitÃ© de l\'air - {address}', fontsize=16, fontweight='bold')
        except Exception as e:
            print(f"âŒ Erreur lors de la crÃ©ation de la visualisation : {e}")
            return None
        
        # 1. Ã‰volution temporelle des PM
        axes[0, 0].plot(location_data['date'], location_data['pm2_5'], 
                       label='PM2.5', color='red', linewidth=2)
        axes[0, 0].plot(location_data['date'], location_data['pm10'], 
                       label='PM10', color='orange', linewidth=2)
        axes[0, 0].axhline(y=20, color='red', linestyle='--', alpha=0.7, label='Seuil PM2.5 (20 Î¼g/mÂ³)')
        axes[0, 0].set_title('Ã‰volution des particules fines (PM)')
        axes[0, 0].set_ylabel('Concentration (Î¼g/mÂ³)')
        axes[0, 0].legend()
        axes[0, 0].grid(True, alpha=0.3)
        
        # 2. Ã‰volution des gaz
        axes[0, 1].plot(location_data['date'], location_data['nitrogen_dioxide'], 
                       label='NOâ‚‚', color='brown', linewidth=2)
        axes[0, 1].plot(location_data['date'], location_data['ozone'], 
                       label='Oâ‚ƒ', color='blue', linewidth=2)
        axes[0, 1].plot(location_data['date'], location_data['sulphur_dioxide'], 
                       label='SOâ‚‚', color='purple', linewidth=2)
        axes[0, 1].set_title('Ã‰volution des gaz polluants')
        axes[0, 1].set_ylabel('Concentration (Î¼g/mÂ³)')
        axes[0, 1].legend()
        axes[0, 1].grid(True, alpha=0.3)
        
        # 3. Distribution des valeurs PM2.5
        axes[1, 0].hist(location_data['pm2_5'].dropna(), bins=20, 
                       color='skyblue', alpha=0.7, edgecolor='black')
        axes[1, 0].axvline(location_data['pm2_5'].mean(), color='red', 
                          linestyle='--', linewidth=2, label=f'Moyenne: {location_data["pm2_5"].mean():.1f}')
        axes[1, 0].axvline(20, color='orange', linestyle='--', linewidth=2, label='Seuil OMS: 20')
        axes[1, 0].set_title('Distribution PM2.5')
        axes[1, 0].set_xlabel('Concentration PM2.5 (Î¼g/mÂ³)')
        axes[1, 0].set_ylabel('FrÃ©quence')
        axes[1, 0].legend()
        axes[1, 0].grid(True, alpha=0.3)
        
        # 4. CorrÃ©lations entre polluants
        pollutants = ['pm2_5', 'pm10', 'nitrogen_dioxide', 'ozone', 'sulphur_dioxide']
        corr_data = location_data[pollutants].corr()
        
        im = axes[1, 1].imshow(corr_data, cmap='coolwarm', vmin=-1, vmax=1)
        axes[1, 1].set_xticks(range(len(pollutants)))
        axes[1, 1].set_yticks(range(len(pollutants)))
        axes[1, 1].set_xticklabels(['PM2.5', 'PM10', 'NOâ‚‚', 'Oâ‚ƒ', 'SOâ‚‚'], rotation=45)
        axes[1, 1].set_yticklabels(['PM2.5', 'PM10', 'NOâ‚‚', 'Oâ‚ƒ', 'SOâ‚‚'])
        axes[1, 1].set_title('CorrÃ©lations entre polluants')
        
        # Ajouter les valeurs de corrÃ©lation
        for i in range(len(pollutants)):
            for j in range(len(pollutants)):
                text = axes[1, 1].text(j, i, f'{corr_data.iloc[i, j]:.2f}',
                                     ha="center", va="center", color="black", fontweight='bold')
        
        plt.colorbar(im, ax=axes[1, 1], shrink=0.6)
        
        try:
            plt.tight_layout()
        except Exception as e:
            print(f"âš ï¸ Warning tight_layout : {e}")
        
        return fig
    
    def generate_report(self, address):
        """GÃ©nÃ©rer un rapport complet pour une adresse"""
        print(f"\nğŸ  RAPPORT DE QUALITÃ‰ DE L'AIR - {address.upper()}")
        print("=" * 80)
        
        # Obtenir le rÃ©sumÃ©
        summary = self.db.get_location_summary(address)
        if not summary:
            print("âŒ Aucune donnÃ©e trouvÃ©e pour cette adresse")
            return
        
        # Affichage du rapport
        print(f"ğŸ“ Adresse : {summary['address']}")
        print(f"ğŸŒ CoordonnÃ©es : {summary['latitude']:.4f}Â°N, {summary['longitude']:.4f}Â°E")
        print(f"ğŸ“Š Nombre de mesures : {summary['total_records']}")
        print(f"ğŸ“… PÃ©riode couverte : {summary['start_date']} Ã  {summary['end_date']}")
        
        print(f"\nğŸŒ¡ï¸ INDICATEURS MOYENS DE QUALITÃ‰ DE L'AIR:")
        print("-" * 50)
        
        # Classification de la qualitÃ© de l'air basÃ©e sur PM2.5
        aqi_label, aqi_color = self.get_air_quality_index(summary['avg_pm2_5'])
        print(f"ğŸ¯ Indice de qualitÃ© : {aqi_label}")
        
        print(f"ğŸ”¸ PM2.5 (particules fines) : {summary['avg_pm2_5']:.1f} Î¼g/mÂ³")
        print(f"ğŸ”¸ PM10 (particules) : {summary['avg_pm10']:.1f} Î¼g/mÂ³") 
        print(f"ğŸ”¸ NOâ‚‚ (dioxyde d'azote) : {summary['avg_no2']:.1f} Î¼g/mÂ³")
        print(f"ğŸ”¸ Oâ‚ƒ (ozone) : {summary['avg_o3']:.1f} Î¼g/mÂ³")
        print(f"ğŸ”¸ SOâ‚‚ (dioxyde de soufre) : {summary['avg_so2']:.1f} Î¼g/mÂ³")
        print(f"ğŸ”¸ CO (monoxyde de carbone) : {summary['avg_co']:.1f} Î¼g/mÂ³")
        
        print(f"\nâš ï¸ ALERTES ET PICS DE POLLUTION:")
        print("-" * 40)
        print(f"ğŸ“ˆ Pic PM2.5 maximum : {summary['max_pm2_5']:.1f} Î¼g/mÂ³")
        print(f"ğŸ“ˆ Pic PM10 maximum : {summary['max_pm10']:.1f} Î¼g/mÂ³")
        print(f"ğŸš¨ Temps en alerte pollution : {summary['pollution_alert_pct']:.1f}%")
        
        # Recommandations
        print(f"\nğŸ’¡ RECOMMANDATIONS:")
        print("-" * 25)
        if summary['avg_pm2_5'] <= 10:
            print("âœ… QualitÃ© de l'air excellente - Aucune prÃ©caution particuliÃ¨re")
        elif summary['avg_pm2_5'] <= 20:
            print("âš ï¸ QualitÃ© de l'air modÃ©rÃ©e - Ã‰vitez les activitÃ©s intenses Ã  l'extÃ©rieur")
        else:
            print("ğŸš¨ QualitÃ© de l'air mauvaise - Limitez les sorties, portez un masque si nÃ©cessaire")
        
        return summary

def main():
    """Fonction principale"""
    print("ğŸŒ APPLICATION DE QUALITÃ‰ DE L'AIR GÃ‰OLOCALISÃ‰E")
    print("=" * 60)
    print("Cette application vous permet de visualiser la qualitÃ© de l'air")
    print("dans votre zone avec une carte interactive et des graphiques dÃ©taillÃ©s.")
    print()
    
    mapper = AirQualityMapper()
    
    # Afficher les locations disponibles
    print("ğŸ“‹ Adresses disponibles dans la base de donnÃ©es :")
    locations = mapper.db.get_unique_locations()
    if not locations.empty:
        for idx, loc in locations.iterrows():
            print(f"  {idx + 1}. {loc['address']} ({loc['records_count']} enregistrements)")
    print()
    
    # Saisie utilisateur
    user_address = input("ğŸ  Entrez votre adresse ou ville : ").strip()
    if not user_address:
        print("âŒ Adresse vide. ArrÃªt du programme.")
        return
    
    # GÃ©nÃ©rer le rapport
    summary = mapper.generate_report(user_address)
    if not summary:
        return
    
    print(f"\nğŸ—ºï¸ GÃ©nÃ©ration de la carte interactive...")
    
    # CrÃ©er la carte
    map_obj, map_summary = mapper.create_location_map(user_address)
    if map_obj:
        map_file = f"map_{user_address.replace(' ', '_').replace(',', '')}_air_quality.html"
        map_obj.save(map_file)
        print(f"âœ… Carte sauvegardÃ©e : {map_file}")
        
        # Ouvrir la carte dans le navigateur
        try:
            webbrowser.open(f'file://{os.path.abspath(map_file)}')
            print("ğŸŒ Carte ouverte dans votre navigateur web")
        except:
            print(f"âš ï¸ Veuillez ouvrir manuellement le fichier : {map_file}")
    
    # CrÃ©er les graphiques
    print(f"\nğŸ“Š GÃ©nÃ©ration des graphiques d'analyse...")
    fig = mapper.create_data_visualization(user_address)
    if fig:
        graph_file = f"analysis_{user_address.replace(' ', '_').replace(',', '')}_air_quality.png"
        fig.savefig(graph_file, dpi=300, bbox_inches='tight')
        print(f"âœ… Graphiques sauvegardÃ©s : {graph_file}")
        plt.show()  # Afficher les graphiques
    
    print(f"\nâœ¨ Analyse complÃ¨te terminÃ©e pour : {user_address}")
    print("ğŸ“ Fichiers gÃ©nÃ©rÃ©s dans le rÃ©pertoire courant")

if __name__ == "__main__":
    main()
